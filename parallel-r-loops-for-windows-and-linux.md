Title: Parallel R Loops in Windows and Linux
Date: 2012-01-17 14:41
Slug: parallel-r-loops-for-windows-and-linux
Modified: 2014-01-07 18:47
Status: published
Category: 
Tags: Linux, Windows, parallel, R


<div class='post'>
Parallel computation may seem difficult to implement and a pain to use, but it is actually quite simple to use. The foreach package provides the basic loop structure, which can utilize various parallel backends to execute the loop in parallel. First, let's go over the basic structure of a foreach loop. To get the foreach package, run the following command: <br /><pre>install.packages("foreach")</pre>Then, initialize the library: <br /><pre>library(foreach)</pre>A basic, nonparallel, foreach loop looks like this: <br /><pre>foreach(i=1:10) %do% {<br /><br />#loop contents here<br /><br />}</pre>To execute the loop in parallel, the %do% command must be replaced with %dopar%: <br /><pre>foreach(i=1:10) %dopar% {<br /><br />#loop contents here<br /><br />}</pre>To capture the return values of the loop: <br /><pre>list<-foreach(i=1:10) %do% {<br />i<br />}</pre>Note that the foreach loop returns a list of values by default.  The foreach package will always return a result with the items in the same order as the counter, even when running in parallel. For example, the above loop will return a list with indices 1 through 10, each containing the same value as their index(1 to 10).<br /><br />In order to return the results as a matrix, you will need to alter the .combine behavior of the foreach loop. This is done in the following code: <br /><pre>matrix<-foreach(i=1:10,.combine=cbind) %do% {<br />i<br />}</pre>This will return a matrix with 10 columns, with values in order from 1 to 10.<br /><br />Likewise, this will return a matrix with 10 rows: <br /><pre>matrix<-foreach(i=1:10,.combine=rbind) %do% {<br />i<br />}</pre>This can be done with multiple return values to create n x k matrices. For example, this will return a 10 x 2 matrix: <br /><pre>matrix<-foreach(i=1:10,.combine=rbind) %do% {<br />c(i,i)<br />}</pre><br /><b>Parallel Backends</b><br /><br />In order to run the foreach loop in parallel(using the %dopar% command), you will need to install and register a parallel backend. Because windows does not support forking, the same backend that works a linux or an OS X environment will not work for windows. Under linux, the doMC package provides a convenient parallel backend.<br /><br />Here is how to use the package(of course, you need to install doMC first): <br /><pre>library(foreach)<br />library(doMC)<br />registerDoMC(2) #change the 2 to your number of CPU cores <br /><br />foreach(i=1:10) %dopar% {<br /><br />#loop contents here<br /><br />}</pre>Under windows, the doSNOW package is very convenient, although it has some issues. I do not recommend the doSMP package, as it has significant issues. <br /><pre>library(doSNOW)<br />library(foreach)<br />cl<-makeCluster(2) #change the 2 to your number of CPU cores<br />registerDoSNOW(cl)<br /><br />foreach(i=1:10) %dopar% {<br /><br />#loop contents here<br /><br />} </pre><br />Edit:  Thanks to an alert reader, I noticed that I neglected to add in the code to stop the clusters.  This will need to be run after you finish executing all of your parallel code if you are using doSNOW. <pre><br />stopCluster(cl)<br /></pre> Also please note that you will need to set the parameter in the makeCluster and registerDoMC functions to the number of CPU cores that your computer possesses, or less if you do not want to use all of your CPU cores. <br/><br/>I hope that this has been a good introduction to parallel loops in R. The new version of R(2.14), also includes the parallel package, which I will discuss further in a later post. You can find more information on the packages mentioned in this article on CRAN. <a href="http://cran.r-project.org/web/packages/foreach/index.html">Foreach</a>, <a href="http://cran.r-project.org/web/packages/doSNOW/index.html">doSNOW</a>, and <a href="http://cran.r-project.org/web/packages/doMC/index.html">doMC</a> can all be found there.</div>